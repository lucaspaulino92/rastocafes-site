<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Área do Produtor - Rasto Cafés</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <style>
      body {font-family: 'Segoe UI', sans-serif;}
      .loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
      .card{transition:transform .2s ease} .card:hover{transform:translateY(-4px)}
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <header class="bg-gradient-to-r from-yellow-700 via-yellow-600 to-yellow-500 text-white py-8 text-center shadow-lg">
      <h1 class="text-4xl font-bold drop-shadow-lg">Área do Produtor</h1>
      <p class="text-sm mt-2">Informações dinâmicas para decisões agrícolas mais seguras</p>
    </header>

    <main class="px-6 md:px-20 py-12 space-y-12">
      <!-- Clima Local -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">Previsão do Tempo</h2>
        <div id="weather" class="text-gray-700 space-y-4">
          <div id="weather-loading" class="flex items-center gap-2"><span class="loader"></span> Carregando previsão...</div>
        </div>
      </section>

      <!-- Commodities -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">Cotações de Commodities (R$)</h2>
        <div id="commodities" class="text-gray-700">
          <div id="commodities-loading" class="flex items-center gap-2"><span class="loader"></span> Buscando cotações...</div>
        </div>
        <p class="text-xs text-gray-500 mt-2">Valores aproximados com base no câmbio comercial. Fonte: Alpha Vantage.</p>
      </section>

      <!-- Notícias Agrícolas -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">Notícias do Setor Agrícola</h2>
        <div id="news" class="space-y-2 text-gray-700">
          <div id="news-loading" class="flex items-center gap-2"><span class="loader"></span> Carregando notícias...</div>
        </div>
        <p class="text-xs text-gray-500 mt-2">Fontes: InfoMoney & Investing RSS.</p>
      </section>
    </main>

    <footer class="py-6 bg-gray-800 text-white text-center">
      <p>&copy; 2025 Rasto Cafés. Todos os direitos reservados.</p>
    </footer>

    <script>
      const fetchJSON = url => fetch(url).then(r => r.json());
      const ALPHA_VANTAGE_KEY = '5TDXOCJ21L6A7P4Z';

      async function loadWeather(){
        if(!navigator.geolocation){document.getElementById('weather').innerHTML='<p>Geolocalização não suportada.</p>';return;}
        navigator.geolocation.getCurrentPosition(async pos=>{
          const {latitude,longitude}=pos.coords;
          const api=`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&forecast_days=7&timezone=America%2FSao_Paulo`;
          try{
            const data=await fetchJSON(api);
            const codes={0:'Céu limpo',1:'Principalmente claro',2:'Parcialmente nublado',3:'Nublado',45:'Neblina',48:'Neblina gelada',51:'Chuvisco leve',53:'Chuvisco moderado',55:'Chuvisco intenso',56:'Chuvisco gelado leve',57:'Chuvisco gelado intenso',61:'Chuva leve',63:'Chuva moderada',65:'Chuva forte',66:'Chuva gelada leve',67:'Chuva gelada forte',71:'Neve leve',73:'Neve moderada',75:'Neve forte',80:'Pancadas leves',81:'Pancadas moderadas',82:'Pancadas fortes',95:'Trovoada',96:'Trovoada c/ granizo leve',99:'Trovoada c/ granizo forte'};
            const cw=data.current_weather;
            const currentHTML=`<p class="text-xl"><strong>${cw.temperature}°C</strong> | ${codes[cw.weathercode]||'Condição desconhecida'}</p><p class="text-gray-600 text-sm">Atualizado: ${new Date(cw.time).toLocaleString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</p>`;
            const dailyRows=data.daily.time.map((date,i)=>{
              const d=new Date(date);
              const day=d.toLocaleDateString('pt-BR',{weekday:'short',day:'2-digit',month:'2-digit'});
              return `<tr><td class="py-1 pr-4">${day}</td><td class="py-1">${codes[data.daily.weathercode[i]]||'-'}</td><td class="py-1">${data.daily.temperature_2m_min[i]}°C / ${data.daily.temperature_2m_max[i]}°C</td></tr>`;
            }).join('');
            const table=`<table class="text-sm mt-4"><thead><tr><th class="text-left">Dia</th><th class="text-left">Condição</th><th class="text-left">Temperatura</th></tr></thead><tbody>${dailyRows}</tbody></table>`;
            document.getElementById('weather').innerHTML=currentHTML+table;
          }catch(e){document.getElementById('weather').innerHTML='<p>Erro ao carregar clima.</p>';}
        },()=>{document.getElementById('weather').innerHTML='<p>Permita localização para ver o clima.</p>';});
      }

      async function loadCommodities(){
        try{
          const symbols = {
            'Café (ICE)': 'KC=F',
            'Soja (CBOT)': 'ZS=F',
            'Milho (CBOT)': 'ZC=F'
          };
          const cotacoes = [];
          let usdbrl = 5.20; // fallback padrão

          const cotacaoBRL = await fetchJSON(`https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=USD&to_currency=BRL&apikey=${ALPHA_VANTAGE_KEY}`);
          if (cotacaoBRL && cotacaoBRL['Realtime Currency Exchange Rate']) {
            usdbrl = parseFloat(cotacaoBRL['Realtime Currency Exchange Rate']['5. Exchange Rate']);
          }

          for (const [nome, codigo] of Object.entries(symbols)) {
            const data = await fetchJSON(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${codigo}&apikey=${ALPHA_VANTAGE_KEY}`);
            const priceUSD = parseFloat(data['Global Quote']['05. price']);
            const priceBRL = (priceUSD * usdbrl).toFixed(2);
            cotacoes.push({ nome, priceBRL });
          }

          const rows = cotacoes.map(c => `<tr><td class="py-1 pr-6">${c.nome}</td><td class="py-1">R$ ${c.priceBRL}</td></tr>`).join('');
          const table = `<table class="text-sm mt-2"><thead><tr><th class="text-left">Produto</th><th class="text-left">Preço (R$)</th></tr></thead><tbody>${rows}</tbody></table>`;
          document.getElementById('commodities').innerHTML = table;
        } catch (e) {
          document.getElementById('commodities').innerHTML = '<p>Erro ao carregar cotações.</p>';
        }
      }

      async function loadNews(){
        try{
          const feeds=[
            'https://www.infomoney.com.br/mercados/feed/',
            'https://br.investing.com/rss/news_25.rss'
          ];
          const results=[];
          for(const f of feeds){
            const api=`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(f)}`;
            try{const data=await fetchJSON(api);results.push(...data.items.slice(0,3));}catch{}
          }
          const html=results.slice(0,6).map(i=>`<a href="${i.link}" target="_blank" class="block hover:underline">• ${i.title}</a>`).join('');
          document.getElementById('news').innerHTML=html||'<p>Sem notícias disponíveis.</p>';
        }catch(e){document.getElementById('news').innerHTML='<p>Erro ao carregar notícias.</p>';}
      }

      loadWeather();
      loadCommodities();
      loadNews();
    </script>
  </body>
</html>
