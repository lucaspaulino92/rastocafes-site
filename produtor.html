<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ãrea do Produtor - Rasto CafÃ©s</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {font-family: 'Segoe UI', sans-serif;}
      .loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
      .card{transition:transform .2s ease} .card:hover{transform:translateY(-4px)}
      .icon { width: 20px; height: 20px; display: inline-block; margin-right: 6px; vertical-align: middle; }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <header class="bg-gradient-to-r from-yellow-700 via-yellow-600 to-yellow-500 text-white py-8 text-center shadow-lg">
      <h1 class="text-4xl font-bold drop-shadow-lg">Ãrea do Produtor</h1>
      <p class="text-sm mt-2">InformaÃ§Ãµes dinÃ¢micas para decisÃµes agrÃ­colas mais seguras</p>
    </header>

    <main class="px-6 md:px-20 py-12 space-y-12">
      <!-- Clima Local -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">PrevisÃ£o do Tempo</h2>
        <div id="weather" class="text-gray-700 space-y-4">
          <div id="weather-loading" class="flex items-center gap-2"><span class="loader"></span> Carregando previsÃ£o...</div>
        </div>
        <canvas id="weatherChart" height="100"></canvas>
      </section>

      <!-- Commodities -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">CotaÃ§Ãµes de Commodities (R$)</h2>
        <div id="commodities" class="text-gray-700">
          <div id="commodities-loading" class="flex items-center gap-2"><span class="loader"></span> Buscando cotaÃ§Ãµes...</div>
        </div>
        <p class="text-xs text-gray-500 mt-2">Valores aproximados com base no cÃ¢mbio comercial. Fonte: Alpha Vantage.</p>
      </section>

      <!-- NotÃ­cias AgrÃ­colas -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">NotÃ­cias do Setor AgrÃ­cola</h2>
        <div id="news" class="space-y-2 text-gray-700">
          <div id="news-loading" class="flex items-center gap-2"><span class="loader"></span> Carregando notÃ­cias...</div>
        </div>
        <p class="text-xs text-gray-500 mt-2">Fontes: InfoMoney & Investing RSS.</p>
      </section>
    </main>

    <footer class="py-6 bg-gray-800 text-white text-center">
      <p>&copy; 2025 Rasto CafÃ©s. Todos os direitos reservados.</p>
    </footer>

    <script>
      const fetchJSON = url => fetch(url).then(r => r.json());
      const ALPHA_VANTAGE_KEY = '5TDXOCJ21L6A7P4Z';

      async function loadWeather(){
        if(!navigator.geolocation){document.getElementById('weather').innerHTML='<p>GeolocalizaÃ§Ã£o nÃ£o suportada.</p>';return;}
        navigator.geolocation.getCurrentPosition(async pos=>{
          const {latitude,longitude}=pos.coords;
          const api=`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&forecast_days=7&timezone=America%2FSao_Paulo`;
          try{
            const data=await fetchJSON(api);
            const codes={0:'â˜€ï¸ CÃ©u limpo',1:'ğŸŒ¤ï¸ Principalmente claro',2:'â›… Parcialmente nublado',3:'â˜ï¸ Nublado',45:'ğŸŒ«ï¸ Neblina',48:'ğŸŒ«ï¸ Neblina gelada',51:'ğŸŒ¦ï¸ Chuvisco leve',53:'ğŸŒ¦ï¸ Chuvisco moderado',55:'ğŸŒ§ï¸ Chuvisco intenso',56:'ğŸŒ§ï¸ Chuvisco gelado leve',57:'ğŸŒ§ï¸ Chuvisco gelado forte',61:'ğŸŒ§ï¸ Chuva leve',63:'ğŸŒ§ï¸ Chuva moderada',65:'ğŸŒ§ï¸ Chuva forte',66:'ğŸŒ¨ï¸ Chuva gelada leve',67:'ğŸŒ¨ï¸ Chuva gelada forte',71:'â„ï¸ Neve leve',73:'â„ï¸ Neve moderada',75:'â„ï¸ Neve forte',80:'ğŸŒ¦ï¸ Pancadas leves',81:'ğŸŒ¦ï¸ Pancadas moderadas',82:'ğŸŒ§ï¸ Pancadas fortes',95:'â›ˆï¸ Trovoada',96:'â›ˆï¸ Trovoada com granizo leve',99:'â›ˆï¸ Trovoada com granizo forte'};
            const cw=data.current_weather;
            const currentHTML=`<p class="text-xl"><strong>${cw.temperature}Â°C</strong> | ${codes[cw.weathercode]||'CondiÃ§Ã£o desconhecida'}</p><p class="text-gray-600 text-sm">Atualizado: ${new Date(cw.time).toLocaleString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</p>`;
            const dailyLabels=[]; const dailyMins=[]; const dailyMaxs=[];
            const dailyRows=data.daily.time.map((date,i)=>{
              const d=new Date(date);
              const day=d.toLocaleDateString('pt-BR',{weekday:'short',day:'2-digit',month:'2-digit'});
              dailyLabels.push(day);
              dailyMins.push(data.daily.temperature_2m_min[i]);
              dailyMaxs.push(data.daily.temperature_2m_max[i]);
              return `<tr><td class="py-1 pr-4">${day}</td><td class="py-1">${codes[data.daily.weathercode[i]]||'-'}</td><td class="py-1">${data.daily.temperature_2m_min[i]}Â°C / ${data.daily.temperature_2m_max[i]}Â°C</td></tr>`;
            }).join('');
            const table=`<table class="text-sm mt-4 w-full border"><thead><tr><th class="text-left border-b pb-1">Dia</th><th class="text-left border-b pb-1">CondiÃ§Ã£o</th><th class="text-left border-b pb-1">Temperatura</th></tr></thead><tbody>${dailyRows}</tbody></table>`;
            document.getElementById('weather').innerHTML=currentHTML+table;

            // GrÃ¡fico
            const ctx = document.getElementById('weatherChart').getContext('2d');
            new Chart(ctx, {
              type: 'line',
              data: {
                labels: dailyLabels,
                datasets: [
                  {
                    label: 'MÃ­nima (Â°C)',
                    data: dailyMins,
                    borderColor: '#60A5FA',
                    backgroundColor: 'transparent'
                  },
                  {
                    label: 'MÃ¡xima (Â°C)',
                    data: dailyMaxs,
                    borderColor: '#F59E0B',
                    backgroundColor: 'transparent'
                  }
                ]
              },
              options: {
                responsive: true,
                plugins: { legend: { position: 'top' } },
                scales: { y: { beginAtZero: false } }
              }
            });
          }catch(e){document.getElementById('weather').innerHTML='<p>Erro ao carregar clima.</p>';}
        },()=>{document.getElementById('weather').innerHTML='<p>Permita localizaÃ§Ã£o para ver o clima.</p>';});
      }

      async function loadCommodities(){
        try{
          const symbols = {
            'CafÃ© (ICE)': 'KC=F',
            'Soja (CBOT)': 'ZS=F',
            'Milho (CBOT)': 'ZC=F'
          };
          const cotacoes = [];
          let usdbrl = 5.20;

          const cotacaoBRL = await fetchJSON(`https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=USD&to_currency=BRL&apikey=${ALPHA_VANTAGE_KEY}`);
          if (cotacaoBRL && cotacaoBRL['Realtime Currency Exchange Rate']) {
            usdbrl = parseFloat(cotacaoBRL['Realtime Currency Exchange Rate']['5. Exchange Rate']);
          }

          for (const [nome, codigo] of Object.entries(symbols)) {
            const data = await fetchJSON(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${codigo}&apikey=${ALPHA_VANTAGE_KEY}`);
            const priceUSD = parseFloat(data['Global Quote']['05. price']);
            const priceBRL = (priceUSD * usdbrl).toFixed(2);
            cotacoes.push({ nome, priceBRL });
          }

          const rows = cotacoes.map(c => `<tr><td class="py-1 pr-6 border-b">${c.nome}</td><td class="py-1 border-b">R$ ${c.priceBRL}</td></tr>`).join('');
          const table = `<table class="text-sm mt-2 w-full"><thead><tr><th class="text-left pb-1 border-b">Produto</th><th class="text-left pb-1 border-b">PreÃ§o (R$)</th></tr></thead><tbody>${rows}</tbody></table>`;
          document.getElementById('commodities').innerHTML = table;
        } catch (e) {
          document.getElementById('commodities').innerHTML = '<p>Erro ao carregar cotaÃ§Ãµes.</p>';
        }
      }

      async function loadNews(){
        try{
          const feeds=[
            'https://www.infomoney.com.br/mercados/feed/',
            'https://br.investing.com/rss/news_25.rss'
          ];
          const results=[];
          for(const f of feeds){
            const api=`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(f)}`;
            try{const data=await fetchJSON(api);results.push(...data.items.slice(0,3));}catch{}
          }
          const html=results.slice(0,6).map(i=>`<a href="${i.link}" target="_blank" class="block hover:underline">â€¢ ${i.title}</a>`).join('');
          document.getElementById('news').innerHTML=html||'<p>Sem notÃ­cias disponÃ­veis.</p>';
        }catch(e){document.getElementById('news').innerHTML='<p>Erro ao carregar notÃ­cias.</p>';}
      }

      loadWeather();
      loadCommodities();
      loadNews();
    </script>
  </body>
</html>
