<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Área do Produtor - Rasto Cafés</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <!-- Supabase & Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {font-family: 'Segoe UI', sans-serif;}
      .loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
      .card{transition:transform .2s ease} .card:hover{transform:translateY(-4px)}
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <!-- Barra superior -->
    <header class="bg-gradient-to-r from-yellow-700 via-yellow-600 to-yellow-500 text-white py-4 px-6 flex items-center justify-between shadow-lg">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold drop-shadow-lg">Área do Produtor</h1>
        <p class="text-xs md:text-sm">Informações dinâmicas para decisões agrícolas mais seguras</p>
      </div>
      <div class="space-x-2">
        <button id="loginBtn" class="bg-white text-yellow-700 font-semibold px-4 py-2 rounded shadow">Entrar</button>
        <button id="logoutBtn" class="hidden bg-white text-yellow-700 font-semibold px-4 py-2 rounded shadow">Sair</button>
      </div>
    </header>

    <!-- Modal de Login -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-sm space-y-4">
        <h2 class="text-xl font-semibold text-center">Login do Produtor</h2>
        <input id="emailInput" type="email" placeholder="Email" class="w-full border p-2 rounded" />
        <input id="passwordInput" type="password" placeholder="Senha" class="w-full border p-2 rounded" />
        <button id="submitLogin" class="w-full bg-yellow-600 text-white py-2 rounded">Entrar</button>
        <button id="closeModal" class="w-full text-sm text-gray-500">Cancelar</button>
        <p id="loginError" class="text-red-600 text-sm hidden"></p>
      </div>
    </div>

    <main class="px-6 md:px-20 py-12 space-y-12">
      <!-- Previsão do Tempo -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">Previsão do Tempo</h2>
        <div id="weather" class="text-gray-700 space-y-4">
          <div id="weather-loading" class="flex items-center gap-2"><span class="loader"></span> Carregando previsão...</div>
        </div>
        <canvas id="weatherChart" height="100"></canvas>
      </section>

      <!-- Cotações -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">Cotações de Commodities (R$)</h2>
        <div id="commodities" class="text-gray-700">
          <div id="commodities-loading" class="flex items-center gap-2"><span class="loader"></span> Buscando cotações...</div>
        </div>
        <p class="text-xs text-gray-500 mt-2">Valores convertidos USD→BRL via Alpha Vantage.</p>
      </section>

      <!-- Notícias -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">Notícias do Setor Agrícola</h2>
        <div id="news" class="space-y-2 text-gray-700">
          <div id="news-loading" class="flex items-center gap-2"><span class="loader"></span> Carregando notícias...</div>
        </div>
        <p class="text-xs text-gray-500 mt-2">Fontes: InfoMoney &amp; Investing RSS.</p>
      </section>
    </main>

    <footer class="py-6 bg-gray-800 text-white text-center">
      <p>&copy; 2025 Rasto Cafés. Todos os direitos reservados.</p>
    </footer>

    <!-- Scripts -->
    <script>
      /* =================== SUPABASE LOGIN =================== */
      const SUPABASE_URL = 'https://spgfbcmzlbuaznegjreu.supabase.co'; // <-- substitua
      const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwZ2ZiY216bGJ1YXpuZWdqcmV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ0MTUyNTksImV4cCI6MjA1OTk5MTI1OX0.lq9_YHkrGVChYzkYL3uvr6CZ3pN2RBa0MJQp0wz3-X0';                 // <-- substitua
      const ALPHA_KEY = '5TDXOCJ21L6A7P4Z';
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      const fetchJSON = url => fetch(url).then(r => r.json());
    
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const loginModal = document.getElementById('loginModal');
      const closeModal = document.getElementById('closeModal');
      const submitLogin = document.getElementById('submitLogin');
      const emailInput = document.getElementById('emailInput');
      const passwordInput = document.getElementById('passwordInput');
      const loginError = document.getElementById('loginError');

      loginBtn.onclick = () => loginModal.classList.remove('hidden');
      closeModal.onclick = () => loginModal.classList.add('hidden');

      submitLogin.onclick = async () => {
        loginError.classList.add('hidden');
        const { error } = await sb.auth.signInWithPassword({ email: emailInput.value, password: passwordInput.value });
        if (error) {
          loginError.textContent = 'Credenciais inválidas';
          loginError.classList.remove('hidden');
        } else {
          loginModal.classList.add('hidden');
          window.location.href = 'painel.html';
        }
      };

      logoutBtn.onclick = async () => {
        await sb.auth.signOut();
        logoutBtn.classList.add('hidden');
        loginBtn.classList.remove('hidden');
      };

      sb.auth.getSession().then(({ data: { session } }) => {
        if (session) {
          loginBtn.classList.add('hidden');
          logoutBtn.classList.remove('hidden');
        }
      });

    
      /* ========== PREVISÃO DO TEMPO ========== */
      async function loadWeather() {
        if (!navigator.geolocation) {
          document.getElementById('weather').innerHTML = '<p>Geolocalização não suportada.</p>'; return;
        }
        navigator.geolocation.getCurrentPosition(async pos => {
          const { latitude, longitude } = pos.coords;
          const api = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&forecast_days=7&timezone=America%2FSao_Paulo`;
          try {
            const data = await fetchJSON(api);
            const codes = {0:'☀️ Céu limpo',1:'🌤️ Principalmente claro',2:'⛅ Parcialmente nublado',3:'☁️ Nublado',45:'🌫️ Neblina',48:'🌫️ Neblina gelada',51:'🌦️ Chuvisco leve',53:'🌦️ Chuvisco moderado',55:'🌧️ Chuvisco intenso',56:'🌧️ Chuvisco gelado leve',57:'🌧️ Chuvisco gelado forte',61:'🌧️ Chuva leve',63:'🌧️ Chuva moderada',65:'🌧️ Chuva forte',66:'🌨️ Chuva gelada leve',67:'🌨️ Chuva gelada forte',71:'❄️ Neve leve',73:'❄️ Neve moderada',75:'❄️ Neve forte',80:'🌦️ Pancadas leves',81:'🌦️ Pancadas moderadas',82:'🌧️ Pancadas fortes',95:'⛈️ Trovoada',96:'⛈️ Trovoada granizo leve',99:'⛈️ Trovoada granizo forte'};
            const cw = data.current_weather;
            const current = `<p class="text-xl"><strong>${cw.temperature}°C</strong> | ${codes[cw.weathercode] || 'Condição'}</p><p class="text-gray-600 text-sm">Atualizado: ${new Date(cw.time).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'})}</p>`;
            const labels = []; const mins = []; const maxs = [];
            const rows = data.daily.time.map((d,i)=>{
              const date=new Date(d);
              labels.push(date.toLocaleDateString('pt-BR',{weekday:'short'}));
              mins.push(data.daily.temperature_2m_min[i]);
              maxs.push(data.daily.temperature_2m_max[i]);
              return `<tr><td class='py-1 pr-4'>${date.toLocaleDateString('pt-BR',{weekday:'short',day:'2-digit',month:'2-digit'})}</td><td class='py-1'>${codes[data.daily.weathercode[i]]||'-'}</td><td class='py-1'>${mins[i]}°C / ${maxs[i]}°C</td></tr>`;
            }).join('');
            document.getElementById('weather').innerHTML = current + `<table class='text-sm mt-4 w-full'><thead><tr><th class='text-left pb-1 border-b'>Dia</th><th class='text-left pb-1 border-b'>Condição</th><th class='text-left pb-1 border-b'>Temp</th></tr></thead><tbody>${rows}</tbody></table>`;
            new Chart(document.getElementById('weatherChart'), {
              type:'line',
              data:{labels,datasets:[{label:'Min',data:mins,borderColor:'#60A5FA',backgroundColor:'transparent'},{label:'Max',data:maxs,borderColor:'#F59E0B',backgroundColor:'transparent'}]},
              options:{plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:false}}}
            });
          } catch {document.getElementById('weather').innerHTML = '<p>Erro ao carregar clima.</p>';}
        },()=>{document.getElementById('weather').innerHTML='<p>Permita localização para ver o clima.</p>';});
      }

      async function loadCommodities() {
        try {
          const map = {'Café (ICE)':'KC=F','Soja (CBOT)':'ZS=F','Milho (CBOT)':'ZC=F'};
          const brlData = await fetchJSON(`https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=USD&to_currency=BRL&apikey=${ALPHA_KEY}`);
          const usdbrl = brlData?.['Realtime Currency Exchange Rate'] ? parseFloat(brlData['Realtime Currency Exchange Rate']['5. Exchange Rate']) : 5.2;
          const rows = await Promise.all(Object.entries(map).map(async ([nome,sym])=>{
            const q = await fetchJSON(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${sym}&apikey=${ALPHA_KEY}`);
            const usd = parseFloat(q['Global Quote']['05. price']);
            const brl = (usd*usdbrl).toFixed(2);
            return `<tr><td class='py-1 pr-6 border-b'>${nome}</td><td class='py-1 border-b'>R$ ${brl}</td></tr>`;
          }));
          document.getElementById('commodities').innerHTML = `<table class='text-sm mt-2 w-full'><thead><tr><th class='text-left pb-1 border-b'>Produto</th><th class='text-left pb-1 border-b'>Preço</th></tr></thead><tbody>${rows.join('')}</tbody></table>`;
        } catch {
          document.getElementById('commodities').innerHTML='<p>Erro ao carregar cotações.</p>';
        }
      }
      
         /* ========== NOTÍCIAS ========== */
      async function loadNews() {
        try {
          const feeds=['https://www.infomoney.com.br/mercados/feed/',
                       'https://br.investing.com/rss/news_25.rss',
                       'https://www.noticiasagricolas.com.br/rss/noticias/rss.xml'
                      ];
          const promises = feeds.map(url => fetchJSON(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`));
        const results = await Promise.all(promises);
        const items = results.flatMap(r => r.items || []).slice(0, 10);
        document.getElementById('news').innerHTML = items.map(i => `<a href="${i.link}" target="_blank" class="block hover:underline">• ${i.title}</a>`).join('');
      }


      /* ========== EXECUÇÃO ========== */
      loadWeather();
      loadCommodities();
      loadNews();
    </script>
  </body>
</html>

