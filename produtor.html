<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>√Årea do Produtor - Rasto Caf√©s</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body{font-family:'Segoe UI',sans-serif}
      .loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite}
      @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
      .card{transition:transform .2s ease}.card:hover{transform:translateY(-4px)}
      table{width:100%;border-collapse:collapse}
      th,td{padding:8px;text-align:left;border-bottom:1px solid #ddd}
      th{background:#f9fafb}
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <!-- Barra superior -->
    <header class="bg-gradient-to-r from-yellow-700 via-yellow-600 to-yellow-500 text-white py-4 px-6 flex items-center justify-between shadow-lg">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold drop-shadow-lg">√Årea do Produtor</h1>
        <p class="text-xs md:text-sm">Informa√ß√µes din√¢micas para decis√µes agr√≠colas mais seguras</p>
      </div>
      <div class="space-x-2">
        <button id="loginBtn" class="bg-white text-yellow-700 font-semibold px-4 py-2 rounded shadow">Entrar</button>
        <button id="logoutBtn" class="hidden bg-white text-yellow-700 font-semibold px-4 py-2 rounded shadow">Sair</button>
      </div>
    </header>

    <!-- Modal Login -->
    <div id="loginModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
      <div class="bg-white p-6 rounded-lg w-full max-w-sm space-y-4">
        <h2 class="text-xl font-semibold text-center">Login do Produtor</h2>
        <input id="emailInput" type="email" placeholder="Email" class="w-full border p-2 rounded">
        <input id="passwordInput" type="password" placeholder="Senha" class="w-full border p-2 rounded">
        <button id="submitLogin" class="w-full bg-yellow-600 text-white py-2 rounded">Entrar</button>
        <button id="closeModal" class="w-full text-sm text-gray-500">Cancelar</button>
        <p id="loginError" class="text-red-600 text-sm hidden"></p>
      </div>
    </div>

    <main class="px-6 md:px-20 py-12 space-y-12">
      <!-- Tempo -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">Previs√£o do Tempo</h2>
        <div id="weather" class="text-gray-700 space-y-4">
          <div id="weather-loading" class="flex items-center gap-2"><span class="loader"></span> Carregando previs√£o...</div>
        </div>
        <canvas id="weatherChart" height="80"></canvas>
      </section>
      <!-- Commodities -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">Cota√ß√µes de Commodities (R$)</h2>
        <div id="commodities" class="text-gray-700">
          <div id="commodities-loading" class="flex items-center gap-2"><span class="loader"></span> Buscando cota√ß√µes...</div>
        </div>
        <p class="text-xs text-gray-500 mt-2">Fonte: Alpha Vantage</p>
      </section>
      <!-- Not√≠cias -->
      <section class="bg-white rounded-xl shadow-md p-6 card">
        <h2 class="text-2xl font-semibold mb-4">Not√≠cias do Setor Agr√≠cola</h2>
        <div id="news" class="space-y-2 text-gray-700">
          <div id="news-loading" class="flex items-center gap-2"><span class="loader"></span> Carregando not√≠cias...</div>
        </div>
      </section>
    </main>

    <footer class="py-6 bg-gray-800 text-white text-center">
      <p>&copy; 2025 Rasto Caf√©s. Todos os direitos reservados.</p>
    </footer>

    <script>
      /* Supabase */
      const SUPABASE_URL='https://spgfbcmzlbuaznegjreu.supabase.co';
      const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwZ2ZiY216bGJ1YXpuZWdqcmV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ0MTUyNTksImV4cCI6MjA1OTk5MTI1OX0.lq9_YHkrGVChYzkYL3uvr6CZ3pN2RBa0MJQp0wz3-X0';
      const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

      /* Utils */
      const $=s=>document.querySelector(s);
      const fetchJSON=u=>fetch(u).then(r=>r.json());
      const ALPHA_KEY='5TDXOCJ21L6A7P4Z';

      /* Login Handlers */
      $('#loginBtn').onclick=()=>$('#loginModal').classList.remove('hidden');
      $('#closeModal').onclick=()=>$('#loginModal').classList.add('hidden');
      $('#submitLogin').onclick=async()=>{
        $('#loginError').classList.add('hidden');
        const {error}=await sb.auth.signInWithPassword({email:$('#emailInput').value,password:$('#passwordInput').value});
        if(error){$('#loginError').textContent='Credenciais inv√°lidas';$('#loginError').classList.remove('hidden');return;}
        location.href='painel.html';
      };
      $('#logoutBtn').onclick=async()=>{await sb.auth.signOut();$('#logoutBtn').classList.add('hidden');$('#loginBtn').classList.remove('hidden');};
      sb.auth.getSession().then(({data:{session}})=>{if(session){$('#loginBtn').classList.add('hidden');$('#logoutBtn').classList.remove('hidden');}});

      /* Weather */
      async function loadWeather(){
        if(!navigator.geolocation){$('#weather').innerHTML='<p>Geolocaliza√ß√£o n√£o suportada.</p>';return;}
        navigator.geolocation.getCurrentPosition(async({coords})=>{
          const api=`https://api.open-meteo.com/v1/forecast?latitude=${coords.latitude}&longitude=${coords.longitude}&current_weather=true&daily=weathercode,temperature_2m_min,temperature_2m_max&forecast_days=7&timezone=America%2FSao_Paulo`;
          try{
            const data=await fetchJSON(api);
            const codes={0:'‚òÄÔ∏è C√©u limpo',1:'üå§Ô∏è Claro',2:'‚õÖ Parcial',3:'‚òÅÔ∏è Nublado',61:'üåßÔ∏è Chuva',80:'üå¶Ô∏è Pancadas',95:'‚õàÔ∏è Trovoada'};
            const cw=data.current_weather;
            const top=`<p class='text-xl'><strong>${cw.temperature}¬∞C</strong> | ${codes[cw.weathercode]||'--'}</p><p class='text-xs text-gray-600'>Atualizado: ${new Date(cw.time).toLocaleTimeString('pt-BR')}</p>`;
            const labels=[],mins=[],maxs=[],rows=data.daily.time.map((t,i)=>{labels.push(new Date(t).toLocaleDateString('pt-BR',{weekday:'short'}));mins.push(data.daily.temperature_2m_min[i]);maxs.push(data.daily.temperature_2m_max[i]);return`<tr><td>${labels[i]}</td><td>${mins[i]}¬∞C</td><td>${maxs[i]}¬∞C</td></tr>`;}).join('');
            $('#weather').innerHTML=top+`<table><thead><tr><th>Dia</th><th>M√≠n</th><th>M√°x</th></tr></thead><tbody>${rows}</tbody></table>`;
            new Chart($('#weatherChart'),{type:'line',data:{labels,datasets:[{label:'Min',data:mins,borderColor:'#60A5FA',backgroundColor:'transparent'},{label:'Max',data:maxs,borderColor:'#F59E0B',backgroundColor:'transparent'}]}});
          }catch{$('#weather').innerHTML='<p>Erro ao carregar clima.</p>';}
          $('#weather-loading')?.remove();
        },()=>{$('#weather').innerHTML='<p>Permita localiza√ß√£o.</p>';$('#weather-loading')?.remove();});
      }

      /* Commodities */
      async function loadCommodities(){
        try{
          const map={'Caf√© (ICE)':'KC=F','Soja (CBOT)':'ZS=F','Milho (CBOT)':'ZC=F'};
          const brl=await fetchJSON(`https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=USD&to_currency=BRL&apikey=${ALPHA_KEY}`);
          const usdbrl=parseFloat(brl['Realtime Currency Exchange Rate']?.['5. Exchange Rate'])||5;
          const rows=await Promise.all(Object.entries(map).map(async([n,s])=>{const q=await fetchJSON(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${s}&apikey=${ALPHA_KEY}`);const p=parseFloat(q['Global Quote']?.['05. price'])||0;return`<tr><td>${n}</td><td>R$ ${(p*usdbrl).toFixed(2)}</td></tr>`;}));
          $('#commodities').innerHTML=`<table><thead><tr><th>Produto</th><th>Pre√ßo</th></tr></thead><tbody>${rows.join('')}</tbody></table>`;
        }catch{$('#commodities').innerHTML='<p>Erro ao carregar cota√ß√µes.</p>';}
        $('#commodities-loading')?.remove();
      }

      /* Not√≠cias */
      async function loadNews(){
        try{
          const feeds=['https://www.infomoney.com.br/mercados/feed/','https://www.noticiasagricolas.com.br/rss/noticias/rss.xml','https://br.investing.com/rss/news_25.rss'];
                    const res=await Promise.all(feeds.map(f => fetchJSON(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(f)}`)));
          const items = res.flatMap(r => r.items || []).slice(0, 10);
          $('#news').innerHTML = items.map(i => 
            `<a href="${i.link}" target="_blank" class="block hover:underline">‚Ä¢ ${i.title}</a>`
          ).join('');
        } catch {
          $('#news').innerHTML = '<p>Erro ao carregar not√≠cias.</p>';
        } finally {
          $('#news-loading')?.remove();
        }
      }

      // Executar carregamentos
      loadWeather();
      loadCommodities();
      loadNews();


